version: "3.9"

services:
  visualization-backend:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./:/app
    command: >
      bash -c "python -m pip install -r requirements.txt && \
      python scripts/seed_mock_patients.py && \
      python -m uvicorn src.visualization.server:app --host 0.0.0.0 --port 8000"
    ports:
      - "8000:8000"
    environment:
      GENESIS_DB_PATH: ${GENESIS_DB_PATH:-./data/genesis_db.json}

  sql-api:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./:/app
    command: >
      bash -c "python -m pip install -r requirements.txt && \
      python scripts/seed_mock_patients.py && \
      python -m uvicorn src.api.log_api:app --host 0.0.0.0 --port 8080"
    ports:
      - "8080:8080"
    environment:
      GENESIS_DB_PATH: ${GENESIS_DB_PATH:-./data/genesis_db.json}

  mysql-gateway:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./:/app
    command: >
      bash -c "python -m pip install -r requirements.txt && \
      python scripts/seed_mock_patients.py && \
      python -m src.api.mysql_server"
    ports:
      - "3306:3306"
    environment:
      GENESIS_DB_PATH: ${GENESIS_DB_PATH:-./data/genesis_db.json}
      GENESIS_MYSQL_HOST: ${GENESIS_MYSQL_HOST:-0.0.0.0}
      GENESIS_MYSQL_PORT: ${GENESIS_MYSQL_PORT:-3306}
    profiles:
      - mysql

  ui:
    image: node:20-bullseye
    working_dir: /app/ui
    volumes:
      - ./:/app
    command: >
      bash -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    ports:
      - "5173:5173"
    depends_on:
      - visualization-backend
      - sql-api
